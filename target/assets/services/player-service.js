streamaApp.factory("playerService",["$stateParams","$sce","$state","$rootScope","socketService","apiService","$interval","$filter",function(d,m,e,g,h,f,l,k){var c=null,a,n={customStartingTime:0,rememberVolumeSetting:!0,videoMetaTitle:"",videoMetaSubtitle:"",videoMetaDescription:"",videoSrc:"",videoType:"",videoTrack:"",videoOverlayEnabled:!0,showEpisodeBrowser:!1,showNextButton:!1,showSocketSession:!0,episodeList:[],selectedEpisodes:[],currentEpisode:{},onSocketSessionCreate:angular.noop,onTimeChange:angular.noop,
onError:angular.noop,onPlay:angular.noop,onPause:angular.noop,onClose:angular.noop,onNext:angular.noop,onVideoClick:angular.noop};return{getVideoOptions:function(){return a},setVideoOptions:function(b){a=angular.copy(n);c=b;a.videoSrc=m.trustAsResourceUrl(b.files[0].src);a.videoType=b.files[0].contentType;b.subtitles&&b.subtitles.length&&(a.videoTrack=m.trustAsResourceUrl(b.subtitles[0].src));a.videoMetaTitle=b.show?b.show.name:b.title;a.videoMetaSubtitle=b.show?b.episodeString+" - "+b.name:b.release_date?
b.release_date.substring(0,4):"";a.videoMetaDescription=b.overview;c.nextEpisode&&(console.log("%c showNextButton","color: deeppink; font-weight: bold; text-shadow: 0 0 5px deeppink;"),a.showNextButton=!0);c.show&&(a.showEpisodeBrowser=!0,f.tvShow.episodesForTvShow(c.show.id).success(function(b){a.episodeList=_.groupBy(b,"season_number");a.selectedEpisodes=a.episodeList[c.season_number];a.currentEpisode={episode:c.episode_number,season:c.season_number,intro_start:c.intro_start,intro_end:c.intro_end,
outro_start:c.outro_start}}));a.customStartingTime=d.currentTime?d.currentTime:b.viewedStatus?b.viewedStatus.currentPlayTime:0;a.onPlay=this.onVideoPlay.bind(a);a.onPause=this.onVideoPause.bind(a);a.onError=this.onVideoError.bind(a);a.onTimeChange=this.onVideoTimeChange.bind(a);a.onClose=this.onVideoClose.bind(a);a.onNext=this.onNext.bind(a);a.onVideoClick=this.onVideoClick.bind(a);a.onSocketSessionCreate=this.onSocketSessionCreate.bind(a);return a},viewingStatusSaveInterval:null,onVideoPlay:function(b,
a){console.log("%c onVideoPlay","color: deeppink; font-weight: bold; text-shadow: 0 0 5px deeppink;");this.viewingStatusSaveInterval=l(function(){var a={videoId:c.id,currentTime:b.currentTime,runtime:b.duration};a.runtime&&a.videoId&&f.viewingStatus.save(a)},5E3);d.sessionId&&!a&&(console.log("%c send socket event PLAY","color: deeppink; font-weight: bold; text-shadow: 0 0 5px deeppink;"),f.websocket.triggerPlayerAction({socketSessionId:d.sessionId,playerAction:"play",currentPlayerTime:b.currentTime}))},
onVideoPause:function(b,a){console.log("%c onVideoPause","color: deeppink; font-weight: bold; text-shadow: 0 0 5px deeppink;",a);l.cancel(this.viewingStatusSaveInterval);d.sessionId&&a&&(b.currentTime+1.5>a.currentPlayerTime||b.currentTime-1.5<a.currentPlayerTime)&&(b.currentTime=a.currentPlayerTime);d.sessionId&&!a&&(console.log("%c send socket event PAUSE","color: deeppink; font-weight: bold; text-shadow: 0 0 5px deeppink;"),f.websocket.triggerPlayerAction({socketSessionId:d.sessionId,playerAction:"pause",
currentPlayerTime:b.currentTime}))},onVideoClose:function(){console.log("%c onVideoClose","color: deeppink; font-weight: bold; text-shadow: 0 0 5px deeppink;");e.go("dash",{})},onVideoError:function(){console.log("%c onVideoError","color: deeppink; font-weight: bold; text-shadow: 0 0 5px deeppink;");"player"==e.current.name&&alertify.alert(k("translate")("MESSAGES.CODEC_PROBLEM"),function(){g.currentUser.authorities.length?c.show?e.go("admin.show",{showId:c.show.id}):e.go("admin.movie",{movieId:c.id}):
e.go("dash",{})})},onVideoTimeChange:function(b,a){f.viewingStatus.save({videoId:c.id,currentTime:b.value,runtime:a});d.sessionId&&f.websocket.triggerPlayerAction({socketSessionId:d.sessionId,playerAction:"timeChange",currentPlayerTime:b.value})},onSocketSessionCreate:function(){alertify.set({buttonReverse:!0,labels:{ok:"OK",cancel:"Cancel"}});alertify.confirm(k("translate")("MESSAGES.SHARE_SOCKET"),function(b){b&&(d.sessionId=h.getUUID(),e.go(e.current,d,{reload:!0}))})},handleMissingFileError:function(b){var a=
!1;b.files&&b.files.length||(a=!0,alertify.alert(k("translate")("MESSAGES.FILE_MISSING"),function(){g.currentUser.authorities.length?b.show?e.go("admin.show",{showId:b.show.id}):e.go("admin.movie",{movieId:b.id}):e.go("dash",{})}));return a},handleWrongBasepathError:function(a){var c=!1,d=a.files[0].src;a=a.files[0].externalLink;var f=location.origin+$("base").attr("href");-1!=d.indexOf(f)||a||(c=!0,alertify.alert(k("translate")("MESSAGES.WRONG_BASEPATH",{basePath:f}),function(){_.find(g.currentUser.authorities,
{authority:"ROLE_ADMIN"})?e.go("settings.settings"):e.go("dash",{})}));return c},registerSocketListener:function(){d.sessionId&&h.registerPlayerSessonListener(d.sessionId)},destroyPlayer:function(){console.log("%c $stateChangeSuccess","color: deeppink; font-weight: bold; text-shadow: 0 0 5px deeppink;");l.cancel(this.viewingStatusSaveInterval);h.unsubscribe()},handleSocketEvent:function(a){if(a.browserSocketUUID!=h.browserSocketUUID)switch(console.log("%c handleSocketEvent","color: deeppink; font-weight: bold; text-shadow: 0 0 5px deeppink;"),
a.playerAction){case "play":g.$broadcast("triggerVideoPlay",a);break;case "pause":g.$broadcast("triggerVideoPause",a);break;case "timeChange":g.$broadcast("triggerVideoTimeChange",a)}},onNext:function(){e.go("player",{videoId:c.nextEpisode.id})},onVideoClick:function(){g.currentUser.pauseVideoOnClick&&g.$broadcast("triggerVideoToggle")}}}]);